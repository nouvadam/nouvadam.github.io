<html>
  <head>
    <meta charset="utf-8"/>
		<style>
	  body {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
	  }
	  canvas {
		  resize: both;
		  overflow: auto;
		  width: 70%;
		  min-height: 400px;
		  border: 2px solid black;
		  image-rendering: -moz-crisp-edges;
          image-rendering: -webkit-crisp-edges;
          image-rendering: pixelated;
          image-rendering: crisp-edges;
		}
		.dropdown {
		  position: relative;
		  display: inline-block;
		}
	</style>
  </head>
  <body>
	<!-- Note the usage of `type=module` here as this is an ES6 module -->
    <script type="module">
      import { Hack, default as init } from './wasm_hack.js';
		
      async function run(rom) {
        let wasm = await init('./wasm_hack_bg.wasm');
		
		// Create new cpu emulator
		const hack = Hack.new(rom);
		
		// Init 2d canvas to render Hack screen
		var canvas = document.getElementById("hack-canvas");
		var new_canvas = canvas.cloneNode( true );
        canvas.parentNode.replaceChild( new_canvas, canvas );
        canvas = new_canvas;
		canvas.height = 256;
		canvas.width = 512;
		const ctx = canvas.getContext('2d');
		
		// Input init
	    window.addEventListener('keydown', function(event) {
			hack.set_key(event.keyCode);
			if([32, 37, 38, 39, 40].indexOf(event.keyCode) > -1) {
				event.preventDefault();
			}
		}, false);
		
		window.addEventListener('keyup', function(event) {
			hack.release_key(event.keyCode);
		});
		
		// Play/Pause functionality
		let animationId = null;
		const isPaused = () => {
		  return animationId === null;
		};
		
		const playPauseButton = document.getElementById("play-pause");

		const play = () => {
		  playPauseButton.textContent = "⏸";
		  renderLoop();
		};

		const pause = () => {
		  playPauseButton.textContent = "▶";
		  cancelAnimationFrame(animationId);
		  animationId = null;
		};

		playPauseButton.addEventListener("click", event => {
		  if (isPaused()) {
			play();
		  } else {
			pause();
		  }
		});
		
		// Basic renderloop
		const renderLoop = () => {
		  
		  // Tick 'speed_input' times
		  hack.tick(document.getElementById("speed_input").value );
		  // Draw Hack screen
		  draw();
		  
		  animationId = requestAnimationFrame(renderLoop);
		};
		
		const draw = () => {
			var canvasWidth = canvas.width;
			var canvasHeight = canvas.height;
			
			const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
			var data = imageData.data;
			
			hack.draw();
			
			let frame_ptr = hack.frame();
			
			const pixels = new Uint8Array(wasm.memory.buffer, frame_ptr, 512 * 256 * 4);
			imageData.data.set(pixels);

			ctx.putImageData(imageData, 0, 0);
		}
		
		draw();
		play();
      }
	  
	  // Select ROM functionality
	  const select_rom = document.querySelector('.select_rom');
	  
	  select_rom.addEventListener('change', (event) => {
		  fetch('rom/'+event.target.value)
		  .then(response => response.text())
		  .then(data => run(data));
		});
	  
    </script>
	

	
	<canvas id="hack-canvas"></canvas>

	<select name="select_rom" class="select_rom">
	  <option disabled selected value> -- Select ROM -- </option>
	  <option value="Bichromia.hex">Bichromia</option>
	  <option value="DrunkenSniper.hex">Drunken Sniper</option>
	  <option value="Render.hex">3D render</option>
	  <option value="Pong.hex">Pong</option>
	  <option value="GASscroller.hex">GASscroller</option>
	  <option value="Trig.hex">Trigonometry</option>
	  <option value="Screen.hex">Screen test</option>
	  <option value="Seven.hex">Seven test</option>
	  <option value="SpeedTest.hex">Speed test</option>
	</select> 
	
	<label for="speed_input">Speed:</label>
	<input type="text" id="speed_input" name="Speed:" value="200000">
	
	<button id="play-pause"></button>
	
  </body>
</html>
